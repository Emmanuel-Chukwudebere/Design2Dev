(()=>{"use strict";function e(e){const n={};return"layoutMode"in e&&(n.layoutMode=e.layoutMode,n.primaryAlign=e.primaryAxisAlignItems,n.counterAlign=e.counterAxisAlignItems,n.padding={top:e.paddingTop,right:e.paddingRight,bottom:e.paddingBottom,left:e.paddingLeft},n.itemSpacing=e.itemSpacing),"fills"in e&&Array.isArray(e.fills)&&(n.fills=e.fills.map((e=>"SOLID"===e.type?{r:e.color.r,g:e.color.g,b:e.color.b,a:e.opacity}:"GRADIENT_LINEAR"===e.type||"GRADIENT_RADIAL"===e.type?{type:"GRADIENT_LINEAR"===e.type?"LINEAR":"RADIAL",stops:e.gradientStops.map((e=>({color:{r:e.color.r,g:e.color.g,b:e.color.b,a:e.color.a},position:e.position})))}:null)).filter(Boolean)),"strokes"in e&&Array.isArray(e.strokes)&&(n.strokes=e.strokes.map((e=>"SOLID"===e.type?{r:e.color.r,g:e.color.g,b:e.color.b,a:e.opacity}:null)).filter(Boolean),n.strokeWeight="number"==typeof e.strokeWeight?e.strokeWeight:0),"cornerRadius"in e&&("number"==typeof e.cornerRadius?n.cornerRadius=e.cornerRadius:e.cornerRadius!==figma.mixed&&"topLeftRadius"in e&&(n.cornerRadius={topLeft:e.topLeftRadius,topRight:e.topRightRadius,bottomLeft:e.bottomLeftRadius,bottomRight:e.bottomRightRadius})),"opacity"in e&&(n.opacity=e.opacity),"effects"in e&&Array.isArray(e.effects)&&(n.effects=e.effects.map((e=>{var n,t,i,o,r,a,s,l,c,d,g,p,y;return"DROP_SHADOW"===e.type||"INNER_SHADOW"===e.type?{type:e.type,color:{r:null!==(t=null===(n=e.color)||void 0===n?void 0:n.r)&&void 0!==t?t:0,g:null!==(o=null===(i=e.color)||void 0===i?void 0:i.g)&&void 0!==o?o:0,b:null!==(a=null===(r=e.color)||void 0===r?void 0:r.b)&&void 0!==a?a:0,a:null!==(s=e.opacity)&&void 0!==s?s:1},offset:{x:null!==(c=null===(l=e.offset)||void 0===l?void 0:l.x)&&void 0!==c?c:0,y:null!==(g=null===(d=e.offset)||void 0===d?void 0:d.y)&&void 0!==g?g:0},blur:null!==(p=e.radius)&&void 0!==p?p:0,spread:null!==(y=e.spread)&&void 0!==y?y:0}:null})).filter((e=>null!==e))),n}new Map;const n={isAnalyzing:!1,isExporting:!1,lastError:null,selectedDesignSystem:"Custom"};function t(e,n){figma.ui.postMessage({type:e,payload:n})}function i(e,t){console.error(`Error in ${t}:`,e),n.lastError=e.message,figma.notify(`Error in ${t}: ${e.message}`,{error:!0})}figma.showUI(__html__,{width:400,height:600}),console.log("Sending initial state"),t("PLUGIN_READY"),t("PAGE_INFO",{name:figma.currentPage.name,nodeCount:figma.currentPage.children.length}),figma.ui.onmessage=o=>{return r=void 0,a=void 0,l=function*(){var r;console.log("Plugin received message:",o);try{switch(o.type){case"INIT":console.log("Received INIT message, sending PLUGIN_READY"),t("PLUGIN_READY"),t("PAGE_INFO",{name:figma.currentPage.name,nodeCount:figma.currentPage.children.length});break;case"ANALYZE_SCREENS":{if(n.isAnalyzing)throw new Error("Analysis already in progress");const a=figma.currentPage.selection.filter((e=>"FRAME"===e.type));if(console.log("Selected frames:",a.length),a.length<1)throw new Error("Please select at least 1 frame to analyze.");if(a.length>8)throw new Error("Please select no more than 8 frames to analyze.");(null===(r=o.payload)||void 0===r?void 0:r.designSystem)&&(n.selectedDesignSystem=o.payload.designSystem),n.isAnalyzing=!0,t("ANALYSIS_STARTED");try{t("ANALYSIS_COMPLETE",{screenSpecs:function(n,t){try{const i=[];for(const o of n){if("FRAME"!==o.type)continue;const n=[],r=new Set,a=new Set,s=new Set;o.findAll((t=>{const i={id:t.id,name:t.name,type:t.type.toLowerCase(),position:{x:t.x,y:t.y},dimensions:{width:t.width,height:t.height},styling:e(t)};"TEXT"===t.type&&(i.content=t.characters),"children"in t&&(i.children=t.children.map((e=>e.id))),"layoutMode"in t&&"NONE"!==t.layoutMode&&(i.autoLayout={direction:t.layoutMode,alignment:t.primaryAxisAlignItems,spacing:t.itemSpacing,padding:{top:t.paddingTop,right:t.paddingRight,bottom:t.paddingBottom,left:t.paddingLeft}}),"effects"in t&&Array.isArray(t.effects)&&t.effects.length>0&&(i.effects=t.effects.map((e=>({type:e.type,properties:e})))),"constraints"in t&&(i.constraints={horizontal:t.constraints.horizontal,vertical:t.constraints.vertical}),n.push(i);const l=t.name.toLowerCase();return l.includes("map")&&r.add("react-native-maps"),(l.includes("camera")||l.includes("avatar-upload"))&&(a.add("android.permission.CAMERA"),a.add("ios.permission.NSCameraUsageDescription")),l.includes("location")&&a.add("android.permission.ACCESS_FINE_LOCATION"),(l.includes("nav")||l.includes("menu"))&&(l.includes("tab")||l.includes("drawer"),"findAll"in t&&"function"==typeof t.findAll&&t.findAll((e=>("FRAME"===e.type&&e!==o&&s.add(e.name),!1)))),!1}));const l={id:`screen-${o.id}`,name:o.name,dimensions:{width:o.width,height:o.height},layout:e(o),designSystem:t,elements:n,dependencies:Array.from(r),permissions:Array.from(a)};s.size>0&&(l.navigation={type:"stack",screens:Array.from(s)}),i.push(l)}return i}catch(e){return console.error("Error analyzing screens:",e),figma.notify("Error analyzing screens. Please try again.",{error:!0}),[]}}(a,n.selectedDesignSystem),designSystem:n.selectedDesignSystem})}catch(e){i(e,"screen analysis"),t("ANALYSIS_FAILED")}finally{n.isAnalyzing=!1}break}case"EXPORT_BUNDLE":{if(n.isExporting)throw new Error("Export already in progress");const{screenSpecs:e}=o.payload;n.isExporting=!0,t("EXPORT_STARTED");try{const i=yield function(e,n){return t=this,i=void 0,r=function*(){try{const t=[],i=[];for(const o of e){t.push({screenName:o.name,designSystem:n,specifications:JSON.stringify(o,null,2),accessibilityRequirements:JSON.stringify({elements:o.elements.map((e=>({id:e.id,name:e.name,type:e.type,role:"text"===e.type?"text":"image"===e.type||"vector"===e.type?"image":"group"})))},null,2)});for(const e of o.elements)if("image"===e.type||"vector"===e.type){const n=figma.getNodeById(e.id);if(n&&"exportAsync"in n){const t=yield n.exportAsync({format:"PNG",constraint:{type:"SCALE",value:2}});i.push({name:`${e.name}.png`,data:t})}}}return{screenSpecs:e,aiPrompts:t,assets:i}}catch(e){throw console.error("Error generating export bundle:",e),figma.notify("Error generating export bundle. Please try again.",{error:!0}),e}},new((o=void 0)||(o=Promise))((function(e,n){function a(e){try{l(r.next(e))}catch(e){n(e)}}function s(e){try{l(r.throw(e))}catch(e){n(e)}}function l(n){var t;n.done?e(n.value):(t=n.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,s)}l((r=r.apply(t,i||[])).next())}));var t,i,o,r}(e,n.selectedDesignSystem);t("EXPORT_COMPLETE",{bundle:i})}catch(e){i(e,"export"),t("EXPORT_FAILED")}finally{n.isExporting=!1}break}default:console.log("Unknown message type:",o.type)}}catch(e){console.error("Error handling message:",e),i(e,"message handling")}},new((s=void 0)||(s=Promise))((function(e,n){function t(e){try{o(l.next(e))}catch(e){n(e)}}function i(e){try{o(l.throw(e))}catch(e){n(e)}}function o(n){var o;n.done?e(n.value):(o=n.value,o instanceof s?o:new s((function(e){e(o)}))).then(t,i)}o((l=l.apply(r,a||[])).next())}));var r,a,s,l},figma.on("close",(()=>{n.isAnalyzing=!1,n.isExporting=!1,n.lastError=null}))})();